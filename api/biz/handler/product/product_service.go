// Code generated by hertz generator.

package product

import (
	"context"
	"log"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"

	"github.com/youperceive/cloudwego_instance/api/biz/model/base"
	productModel "github.com/youperceive/cloudwego_instance/api/biz/model/product"
	pkgProduct "github.com/youperceive/cloudwego_instance/api/pkg/product"
)

// 基础响应成功常量
const (
	codeSuccess = 0
	msgSuccess  = "success"
	codeFailed  = -1
)

// CreateProduct .
// @router /create_product [POST]
func CreateProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.CreateProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	productID, err := pkgProduct.CreateProduct(
		ctx,
		req.MerchantID, // 商户ID
		req.Name,       // 商品名称
		req.Ext,        // 扩展字段
	)

	// 2. 封装响应（透传）
	resp := &productModel.CreateProductResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("CreateProduct failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	} else {
		resp.ProductID = &productID // 返回创建的商品ID
	}

	c.JSON(consts.StatusOK, resp)
}

// DeleteProduct .
// @router /delete_product [POST]
func DeleteProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.DeleteProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	err = pkgProduct.DeleteProduct(
		ctx,
		req.MerchantID, // 商户ID
		req.ProductID,  // 商品ID
	)

	// 2. 封装响应（透传）
	resp := &productModel.DeleteProductResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("DeleteProduct failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	}

	c.JSON(consts.StatusOK, resp)
}

// UpdateProduct .
// @router /update_product [POST]
func UpdateProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.UpdateProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	err = pkgProduct.UpdateProduct(
		ctx,
		req.MerchantID, // 商户ID
		req.ProductID,  // 商品ID
		req.Name,       // 可选更新名称
		&req.Ext,       // 可选更新扩展字段
	)

	// 2. 封装响应（透传）
	resp := &productModel.UpdateProductResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("UpdateProduct failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	}

	c.JSON(consts.StatusOK, resp)
}

// GetProduct .
// @router /get_product [POST]
func GetProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.GetProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	productInfo, err := pkgProduct.GetProduct(
		ctx,
		req.MerchantID, // 商户ID
		req.ProductID,  // 商品ID
	)

	// 2. 封装响应（透传）
	resp := &productModel.GetProductResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("GetProduct failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	} else {
		// 转换 pkg 结构体为 model 结构体
		resp.Product = &productModel.Product{
			ID:         productInfo.ID,
			MerchantID: productInfo.MerchantID,
			Name:       productInfo.Name,
			Ext:        productInfo.Ext,
		}
	}

	c.JSON(consts.StatusOK, resp)
}

// CreateSku .
// @router /create_sku [POST]
func CreateSku(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.CreateSkuRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	skuID, err := pkgProduct.CreateSku(
		ctx,
		req.MerchantID, // 商户ID
		req.ProductID,  // 商品ID
		req.SkuCode,    // 规格编码
		req.Price,      // 单价（分）
		req.Stock,      // 库存
	)

	// 2. 封装响应（透传）
	resp := &productModel.CreateSkuResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("CreateSku failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	} else {
		resp.SkuID = &skuID // 返回创建的SKU ID
	}

	c.JSON(consts.StatusOK, resp)
}

// DeleteSku .
// @router /delete_sku [POST]
func DeleteSku(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.DeleteSkuRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	err = pkgProduct.DeleteSku(
		ctx,
		req.MerchantID, // 商户ID
		req.SkuID,      // SKU ID
	)

	// 2. 封装响应（透传）
	resp := &productModel.DeleteSkuResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("DeleteSku failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	}

	c.JSON(consts.StatusOK, resp)
}

// UpdateSku .
// @router /update_sku [POST]
func UpdateSku(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.UpdateSkuRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	err = pkgProduct.UpdateSku(
		ctx,
		req.MerchantID, // 商户ID
		req.SkuID,      // SKU ID
		req.SkuCode,    // 可选更新规格编码
		req.Price,      // 可选更新价格
		req.Stock,      // 可选更新库存
	)

	// 2. 封装响应（透传）
	resp := &productModel.UpdateSkuResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("UpdateSku failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	}

	c.JSON(consts.StatusOK, resp)
}

// GetSku .
// @router /get_sku [POST]
func GetSku(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.GetSkuRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	skuInfo, err := pkgProduct.GetSku(
		ctx,
		req.SkuID, // SKU ID（订单端无需商户ID）
	)

	// 2. 封装响应（透传）
	resp := &productModel.GetSkuResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("GetSku failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	} else {
		// 转换 pkg 结构体为 model 结构体
		resp.Sku = &productModel.Sku{
			ID:        skuInfo.ID,
			ProductID: skuInfo.ProductID,
			SkuCode:   skuInfo.SkuCode,
			Price:     skuInfo.Price,
			Stock:     skuInfo.Stock,
		}
	}

	c.JSON(consts.StatusOK, resp)
}

// DeductSkuStock .
// @router /deduct_sku [POST]
func DeductSkuStock(ctx context.Context, c *app.RequestContext) {
	var err error
	var req productModel.DeductSkuStockRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 1. 调用 pkg 层 CRUD
	remainStock, err := pkgProduct.DeductSkuStock(
		ctx,
		req.SkuID, // SKU ID
		req.Count, // 购买数量
	)

	// 2. 封装响应（透传）
	resp := &productModel.DeductSkuStockResponse{
		BaseResp: &base.BaseResponse{
			Code: codeSuccess,
			Msg:  msgSuccess,
		},
	}
	if err != nil {
		log.Printf("DeductSkuStock failed: %v", err)
		resp.BaseResp.Code = codeFailed
		resp.BaseResp.Msg = err.Error()
	} else {
		resp.RemainStock = &remainStock // 返回剩余库存
	}

	c.JSON(consts.StatusOK, resp)
}
