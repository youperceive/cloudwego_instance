// Code generated by hertz generator.

package user_account

import (
	"context"
	"log"
	"os"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/cloudwego/kitex/client"
	"github.com/youperceive/cloudwego_instance/api/biz/model/base"
	user_account "github.com/youperceive/cloudwego_instance/api/biz/model/user_account"

	base_k "github.com/youperceive/cloudwego_instance/rpc/user_account/kitex_gen/base"
	user_account_k "github.com/youperceive/cloudwego_instance/rpc/user_account/kitex_gen/user_account"
	user_account_service_k "github.com/youperceive/cloudwego_instance/rpc/user_account/kitex_gen/user_account/useraccountservice"
)

var userAccountClient user_account_service_k.Client

func init() {
	cli, err := user_account_service_k.NewClient(
		"user_account_service",
		client.WithHostPorts(os.Getenv("user_account_service_addr")),
	)
	if err != nil {
		log.Fatal(err)
	}
	userAccountClient = cli
}

// Register .
// @router user/register [POST]
func Register(ctx context.Context, c *app.RequestContext) {
	var err error
	var req user_account.RegisterRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	reqK := &user_account_k.RegisterRequest{
		Username:   req.Username,
		Target:     req.Target,
		TargetType: base_k.TargetType(req.TargetType),
		Password:   req.Password,
		Captcha:    req.Captcha,
		UserType:   req.UserType,
	}
	respK, err := userAccountClient.Register(ctx, reqK)
	if err != nil {
		log.Println(err.Error() + respK.String())
		c.JSON(consts.StatusInternalServerError, &user_account.RegisterResponse{
			BaseResp: &base.BaseResponse{
				Code: base.Code_SERVICE_ERR,
				Msg:  "Internal Error",
			},
		})
		return
	}

	c.JSON(consts.StatusOK, &user_account.RegisterResponse{
		BaseResp: &base.BaseResponse{
			Code: base.Code_SUCCESS,
			Msg:  "Success",
		},
	})
}

// Login .
// @router user/login [POST]
func Login(ctx context.Context, c *app.RequestContext) {
	var err error
	var req user_account.LoginRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	reqK := &user_account_k.LoginRequest{
		Target:     req.Target,
		TargetType: base_k.TargetType(req.TargetType),
		Password:   req.Password,
	}
	respK, err := userAccountClient.Login(ctx, reqK)
	if err != nil {
		log.Println(err.Error() + respK.String())
		c.JSON(consts.StatusInternalServerError, &user_account.LoginResponse{
			BaseResp: &base.BaseResponse{
				Code: base.Code_SERVICE_ERR,
				Msg:  "Internal Error",
			},
		})
		return
	}

	c.JSON(consts.StatusOK, &user_account.LoginResponse{
		BaseResp: &base.BaseResponse{
			Code: base.Code_SUCCESS,
			Msg:  "Success",
		},
		Token: respK.Token,
	})
}

// Update .
// @router user/update [POST]
func Update(ctx context.Context, c *app.RequestContext) {
	var err error
	var req user_account.UpdateRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	reqK := &user_account_k.UpdateRequest{
		Id:       req.ID,
		Username: req.Username,
		Email:    req.Email,
		Phone:    req.Phone,
		Password: req.Password,
		UserType: req.UserType,
		Status:   req.Status,
	}
	respK, err := userAccountClient.Update(ctx, reqK)
	if err != nil {
		log.Println(err.Error() + respK.String())
		c.JSON(consts.StatusInternalServerError, &user_account.UpdateResponse{
			BaseResp: &base.BaseResponse{
				Code: base.Code_SERVICE_ERR,
				Msg:  "Internal Error",
			},
		})
		return
	}

	c.JSON(consts.StatusOK, &user_account.UpdateResponse{
		BaseResp: &base.BaseResponse{
			Code: base.Code_SUCCESS,
			Msg:  "Success",
		},
	})
}
