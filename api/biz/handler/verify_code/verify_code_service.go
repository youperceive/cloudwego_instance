// Code generated by hertz generator.

package verify_code

import (
	"context"
	"log"
	"os"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/cloudwego/kitex/client"
	base "github.com/youperceive/cloudwego_instance/api/biz/model/base"
	verify_code "github.com/youperceive/cloudwego_instance/api/biz/model/verify_code"

	base_k "github.com/youperceive/cloudwego_instance/rpc/verify_code/kitex_gen/base"
	verify_code_k "github.com/youperceive/cloudwego_instance/rpc/verify_code/kitex_gen/verify_code"
	verify_code_service_k "github.com/youperceive/cloudwego_instance/rpc/verify_code/kitex_gen/verify_code/verifycodeservice"
)

var verifyCodeClient verify_code_service_k.Client

func init() {
	cli, err := verify_code_service_k.NewClient(
		"verify_code_service",
		client.WithHostPorts(os.Getenv("verify_code_service_addr")),
	)
	if err != nil {
		log.Fatal(err)
	}
	verifyCodeClient = cli
}

// GenerateCaptcha .
// @router /verify_code/generate [POST]
func GenerateCaptcha(ctx context.Context, c *app.RequestContext) {
	var err error
	var req verify_code.GenerateCaptchaRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	reqK := &verify_code_k.GenerateCaptchaRequest{
		Type:   base_k.TargetType(req.Type),
		Target: req.Target,
		// Purpose:          req.Purpose, 文档标明已丢弃
		ExpireSeconds:    300,
		MaxValidateTimes: 3,
		Proj:             "order",
		BizType:          req.BizType,
	}
	respK, err := verifyCodeClient.GenerateCaptcha(ctx, reqK)
	if err != nil {
		log.Println(err.Error() + respK.String())
		c.JSON(consts.StatusOK, &verify_code.GenerateCaptchaResponse{
			BaseResp: &base.BaseResponse{
				Code: base.Code_SERVICE_ERR,
				Msg:  "Internal Error",
			},
		})
		return
	}

	c.JSON(consts.StatusOK, &verify_code.GenerateCaptchaResponse{
		BaseResp: &base.BaseResponse{
			Code: base.Code_SUCCESS,
			Msg:  "Success",
		},
	})
}
